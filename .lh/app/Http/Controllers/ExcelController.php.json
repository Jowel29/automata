{
    "sourceFile": "app/Http/Controllers/ExcelController.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 21,
            "patches": [
                {
                    "date": 1762469581934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762469588585,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,17 +26,14 @@\n \n         $callback = function () use ($data) {\n             $file = fopen('php://output', 'w');\n \n-            // Add BOM for Excel UTF-8 support\n             fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n \n-            // Write headers\n             if (!empty($data)) {\n                 fputcsv($file, array_keys($data[0]));\n             }\n \n-            // Write data\n             foreach ($data as $row) {\n                 fputcsv($file, $row);\n             }\n \n"
                },
                {
                    "date": 1762475354841,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,35 @@\n <?php\n+\n namespace App\\Http\\Controllers;\n \n-use Illuminate\\Support\\Facades\\Response;\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n \n class ExcelController extends Controller\n {\n-    public function downloadExcel()\n+    public function downloadExcel(Request $request)\n     {\n         $data = session('extracted_data', []);\n-\n+        \n         if (empty($data)) {\n-            return redirect()->back()\n-                ->with('error', 'No data to export.');\n+            return redirect()->back()->with('error', 'No data to export.');\n         }\n \n+        $exportType = $request->get('type', 'new');\n+\n+        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n+            return $this->appendToExistingFile($request, $data);\n+        }\n+\n+        return $this->createNewFile($data);\n+    }\n+\n+    /**\n+     * إنشاء ملف CSV جديد\n+     */\n+    private function createNewFile($data)\n+    {\n         $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n \n         $headers = [\n             'Content-Type' => 'text/csv; charset=UTF-8',\n@@ -25,15 +40,18 @@\n         ];\n \n         $callback = function () use ($data) {\n             $file = fopen('php://output', 'w');\n-\n+            \n+            // Add BOM for Excel UTF-8 support\n             fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n \n+            // Write headers\n             if (!empty($data)) {\n                 fputcsv($file, array_keys($data[0]));\n             }\n \n+            // Write data\n             foreach ($data as $row) {\n                 fputcsv($file, $row);\n             }\n \n@@ -41,5 +59,96 @@\n         };\n \n         return response()->stream($callback, 200, $headers);\n     }\n+\n+    /**\n+     * إضافة البيانات لملف موجود\n+     */\n+    private function appendToExistingFile(Request $request, $newData)\n+    {\n+        $existingFile = $request->file('existing_file');\n+        $extension = strtolower($existingFile->getClientOriginalExtension());\n+\n+        // قراءة الملف الموجود\n+        $existingData = [];\n+        \n+        if ($extension === 'csv') {\n+            $existingData = $this->readCSV($existingFile);\n+        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+            $existingData = $this->readExcel($existingFile);\n+        }\n+\n+        // دمج البيانات القديمة مع الجديدة\n+        $mergedData = array_merge($existingData, $newData);\n+\n+        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($mergedData) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($mergedData)) {\n+                fputcsv($file, array_keys($mergedData[0]));\n+            }\n+\n+            foreach ($mergedData as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function readCSV($file)\n+    {\n+        $data = [];\n+        $path = $file->getRealPath();\n+        \n+        if (($handle = fopen($path, 'r')) !== false) {\n+            $headers = fgetcsv($handle);\n+            \n+            while (($row = fgetcsv($handle)) !== false) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            fclose($handle);\n+        }\n+        \n+        return $data;\n+    }\n+\n+    private function readExcel($file)\n+    {\n+        try {\n+            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n+            $sheet = $spreadsheet->getActiveSheet();\n+            $rows = $sheet->toArray();\n+            \n+            $headers = array_shift($rows);\n+            $data = [];\n+            \n+            foreach ($rows as $row) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            return $data;\n+        } catch (\\Exception $e) {\n+            return [];\n+        }\n+    }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762475363137,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,26 +60,21 @@\n \n         return response()->stream($callback, 200, $headers);\n     }\n \n-    /**\n-     * إضافة البيانات لملف موجود\n-     */\n     private function appendToExistingFile(Request $request, $newData)\n     {\n         $existingFile = $request->file('existing_file');\n         $extension = strtolower($existingFile->getClientOriginalExtension());\n \n-        // قراءة الملف الموجود\n         $existingData = [];\n         \n         if ($extension === 'csv') {\n             $existingData = $this->readCSV($existingFile);\n         } elseif (in_array($extension, ['xlsx', 'xls'])) {\n             $existingData = $this->readExcel($existingFile);\n         }\n \n-        // دمج البيانات القديمة مع الجديدة\n         $mergedData = array_merge($existingData, $newData);\n \n         $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n \n"
                },
                {
                    "date": 1762475378372,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,147 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n+\n+class ExcelController extends Controller\n+{\n+    public function downloadExcel(Request $request)\n+    {\n+        $data = session('extracted_data', []);\n+        \n+        if (empty($data)) {\n+            return redirect()->back()->with('error', 'No data to export.');\n+        }\n+\n+        $exportType = $request->get('type', 'new');\n+\n+        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n+            return $this->appendToExistingFile($request, $data);\n+        }\n+\n+        return $this->createNewFile($data);\n+    }\n+\n+    /**\n+     * إنشاء ملف CSV جديد\n+     */\n+    private function createNewFile($data)\n+    {\n+        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($data) {\n+            $file = fopen('php://output', 'w');\n+            \n+            // Add BOM for Excel UTF-8 support\n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($data)) {\n+                fputcsv($file, array_keys($data[0]));\n+            }\n+\n+            foreach ($data as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function appendToExistingFile(Request $request, $newData)\n+    {\n+        $existingFile = $request->file('existing_file');\n+        $extension = strtolower($existingFile->getClientOriginalExtension());\n+\n+        $existingData = [];\n+        \n+        if ($extension === 'csv') {\n+            $existingData = $this->readCSV($existingFile);\n+        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+            $existingData = $this->readExcel($existingFile);\n+        }\n+\n+        $mergedData = array_merge($existingData, $newData);\n+\n+        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($mergedData) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($mergedData)) {\n+                fputcsv($file, array_keys($mergedData[0]));\n+            }\n+\n+            foreach ($mergedData as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function readCSV($file)\n+    {\n+        $data = [];\n+        $path = $file->getRealPath();\n+        \n+        if (($handle = fopen($path, 'r')) !== false) {\n+            $headers = fgetcsv($handle);\n+            \n+            while (($row = fgetcsv($handle)) !== false) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            fclose($handle);\n+        }\n+        \n+        return $data;\n+    }\n+\n+    private function readExcel($file)\n+    {\n+        try {\n+            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n+            $sheet = $spreadsheet->getActiveSheet();\n+            $rows = $sheet->toArray();\n+            \n+            $headers = array_shift($rows);\n+            $data = [];\n+            \n+            foreach ($rows as $row) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            return $data;\n+        } catch (\\Exception $e) {\n+            return [];\n+        }\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762475385030,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,143 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n+\n+class ExcelController extends Controller\n+{\n+    public function downloadExcel(Request $request)\n+    {\n+        $data = session('extracted_data', []);\n+        \n+        if (empty($data)) {\n+            return redirect()->back()->with('error', 'No data to export.');\n+        }\n+\n+        $exportType = $request->get('type', 'new');\n+\n+        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n+            return $this->appendToExistingFile($request, $data);\n+        }\n+\n+        return $this->createNewFile($data);\n+    }\n+\n+    private function createNewFile($data)\n+    {\n+        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($data) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($data)) {\n+                fputcsv($file, array_keys($data[0]));\n+            }\n+\n+            foreach ($data as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function appendToExistingFile(Request $request, $newData)\n+    {\n+        $existingFile = $request->file('existing_file');\n+        $extension = strtolower($existingFile->getClientOriginalExtension());\n+\n+        $existingData = [];\n+        \n+        if ($extension === 'csv') {\n+            $existingData = $this->readCSV($existingFile);\n+        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+            $existingData = $this->readExcel($existingFile);\n+        }\n+\n+        $mergedData = array_merge($existingData, $newData);\n+\n+        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($mergedData) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($mergedData)) {\n+                fputcsv($file, array_keys($mergedData[0]));\n+            }\n+\n+            foreach ($mergedData as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function readCSV($file)\n+    {\n+        $data = [];\n+        $path = $file->getRealPath();\n+        \n+        if (($handle = fopen($path, 'r')) !== false) {\n+            $headers = fgetcsv($handle);\n+            \n+            while (($row = fgetcsv($handle)) !== false) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            fclose($handle);\n+        }\n+        \n+        return $data;\n+    }\n+\n+    private function readExcel($file)\n+    {\n+        try {\n+            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n+            $sheet = $spreadsheet->getActiveSheet();\n+            $rows = $sheet->toArray();\n+            \n+            $headers = array_shift($rows);\n+            $data = [];\n+            \n+            foreach ($rows as $row) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            return $data;\n+        } catch (\\Exception $e) {\n+            return [];\n+        }\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762476788693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,157 +6,26 @@\n use Illuminate\\Support\\Facades\\Storage;\n \n class ExcelController extends Controller\n {\n-    public function downloadExcel(Request $request)\n+    // عرض صفحة اختيار نوع التصدير\n+    public function showExportOptions()\n     {\n         $data = session('extracted_data', []);\n         \n         if (empty($data)) {\n-            return redirect()->back()->with('error', 'No data to export.');\n+            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n         }\n \n-        $exportType = $request->get('type', 'new');\n-\n-        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n-            return $this->appendToExistingFile($request, $data);\n-        }\n-\n-        return $this->createNewFile($data);\n+        return view('pdf.export-options', ['dataCount' => count($data)]);\n     }\n \n-    private function createNewFile($data)\n-    {\n-        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($data) {\n-            $file = fopen('php://output', 'w');\n-            \n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            if (!empty($data)) {\n-                fputcsv($file, array_keys($data[0]));\n-            }\n-\n-            foreach ($data as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function appendToExistingFile(Request $request, $newData)\n-    {\n-        $existingFile = $request->file('existing_file');\n-        $extension = strtolower($existingFile->getClientOriginalExtension());\n-\n-        $existingData = [];\n-        \n-        if ($extension === 'csv') {\n-            $existingData = $this->readCSV($existingFile);\n-        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n-            $existingData = $this->readExcel($existingFile);\n-        }\n-\n-        $mergedData = array_merge($existingData, $newData);\n-\n-        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($mergedData) {\n-            $file = fopen('php://output', 'w');\n-            \n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            if (!empty($mergedData)) {\n-                fputcsv($file, array_keys($mergedData[0]));\n-            }\n-\n-            foreach ($mergedData as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function readCSV($file)\n-    {\n-        $data = [];\n-        $path = $file->getRealPath();\n-        \n-        if (($handle = fopen($path, 'r')) !== false) {\n-            $headers = fgetcsv($handle);\n-            \n-            while (($row = fgetcsv($handle)) !== false) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n-                }\n-            }\n-            \n-            fclose($handle);\n-        }\n-        \n-        return $data;\n-    }\n-\n-    private function readExcel($file)\n-    {\n-        try {\n-            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n-            $sheet = $spreadsheet->getActiveSheet();\n-            $rows = $sheet->toArray();\n-            \n-            $headers = array_shift($rows);\n-            $data = [];\n-            \n-            foreach ($rows as $row) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n-                }\n-            }\n-            \n-            return $data;\n-        } catch (\\Exception $e) {\n-            return [];\n-        }\n-    }\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Storage;\n-\n-class ExcelController extends Controller\n-{\n     public function downloadExcel(Request $request)\n     {\n         $data = session('extracted_data', []);\n         \n         if (empty($data)) {\n-            return redirect()->back()->with('error', 'No data to export.');\n+            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n         }\n \n         $exportType = $request->get('type', 'new');\n \n@@ -166,11 +35,8 @@\n \n         return $this->createNewFile($data);\n     }\n \n-    /**\n-     * إنشاء ملف CSV جديد\n-     */\n     private function createNewFile($data)\n     {\n         $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n \n@@ -184,9 +50,8 @@\n \n         $callback = function () use ($data) {\n             $file = fopen('php://output', 'w');\n             \n-            // Add BOM for Excel UTF-8 support\n             fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n \n             if (!empty($data)) {\n                 fputcsv($file, array_keys($data[0]));\n@@ -198,177 +63,53 @@\n \n             fclose($file);\n         };\n \n+        // حفظ رسالة النجاح في الجلسة\n+        session()->flash('success', 'تم إنشاء الملف الجديد وتحميله بنجاح! (' . count($data) . ' سجل)');\n+\n         return response()->stream($callback, 200, $headers);\n     }\n \n     private function appendToExistingFile(Request $request, $newData)\n     {\n+        $request->validate([\n+            'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n+        ], [\n+            'existing_file.required' => 'يرجى اختيار ملف موجود',\n+            'existing_file.mimes' => 'يجب أن يكون الملف من نوع CSV أو Excel',\n+            'existing_file.max' => 'حجم الملف يجب أن لا يتجاوز 10 ميجابايت'\n+        ]);\n+\n         $existingFile = $request->file('existing_file');\n         $extension = strtolower($existingFile->getClientOriginalExtension());\n \n         $existingData = [];\n         \n-        if ($extension === 'csv') {\n-            $existingData = $this->readCSV($existingFile);\n-        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n-            $existingData = $this->readExcel($existingFile);\n-        }\n-\n-        $mergedData = array_merge($existingData, $newData);\n-\n-        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($mergedData) {\n-            $file = fopen('php://output', 'w');\n-            \n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            if (!empty($mergedData)) {\n-                fputcsv($file, array_keys($mergedData[0]));\n-            }\n-\n-            foreach ($mergedData as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function readCSV($file)\n-    {\n-        $data = [];\n-        $path = $file->getRealPath();\n-        \n-        if (($handle = fopen($path, 'r')) !== false) {\n-            $headers = fgetcsv($handle);\n-            \n-            while (($row = fgetcsv($handle)) !== false) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n-                }\n-            }\n-            \n-            fclose($handle);\n-        }\n-        \n-        return $data;\n-    }\n-\n-    private function readExcel($file)\n-    {\n         try {\n-            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n-            $sheet = $spreadsheet->getActiveSheet();\n-            $rows = $sheet->toArray();\n-            \n-            $headers = array_shift($rows);\n-            $data = [];\n-            \n-            foreach ($rows as $row) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n-                }\n+            if ($extension === 'csv') {\n+                $existingData = $this->readCSV($existingFile);\n+            } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+                $existingData = $this->readExcel($existingFile);\n             }\n-            \n-            return $data;\n         } catch (\\Exception $e) {\n-            return [];\n+            return redirect()->back()->with('error', 'فشل قراءة الملف الموجود: ' . $e->getMessage());\n         }\n-    }\n-}\n-<?php\n \n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Storage;\n-\n-class ExcelController extends Controller\n-{\n-    public function downloadExcel(Request $request)\n-    {\n-        $data = session('extracted_data', []);\n-        \n-        if (empty($data)) {\n-            return redirect()->back()->with('error', 'No data to export.');\n-        }\n-\n-        $exportType = $request->get('type', 'new');\n-\n-        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n-            return $this->appendToExistingFile($request, $data);\n-        }\n-\n-        return $this->createNewFile($data);\n-    }\n-\n-    /**\n-     * إنشاء ملف CSV جديد\n-     */\n-    private function createNewFile($data)\n-    {\n-        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($data) {\n-            $file = fopen('php://output', 'w');\n+        // التحقق من تطابق الأعمدة\n+        if (!empty($existingData) && !empty($newData)) {\n+            $existingColumns = array_keys($existingData[0]);\n+            $newColumns = array_keys($newData[0]);\n             \n-            // Add BOM for Excel UTF-8 support\n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            // Write headers\n-            if (!empty($data)) {\n-                fputcsv($file, array_keys($data[0]));\n+            if ($existingColumns !== $newColumns) {\n+                return redirect()->back()->with('error', 'أعمدة الملف الموجود لا تتطابق مع البيانات الجديدة.');\n             }\n-\n-            // Write data\n-            foreach ($data as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function appendToExistingFile(Request $request, $newData)\n-    {\n-        $existingFile = $request->file('existing_file');\n-        $extension = strtolower($existingFile->getClientOriginalExtension());\n-\n-        $existingData = [];\n-        \n-        if ($extension === 'csv') {\n-            $existingData = $this->readCSV($existingFile);\n-        } elseif (in_array($extension, ['xlsx', 'xls'])) {\n-            $existingData = $this->readExcel($existingFile);\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n+        $originalFilename = pathinfo($existingFile->getClientOriginalName(), PATHINFO_FILENAME);\n+        $filename = $originalFilename . '_merged_' . date('Y-m-d_His') . '.csv';\n \n-        $filename = 'merged_data_' . date('Y-m-d_His') . '.csv';\n-\n         $headers = [\n             'Content-Type' => 'text/csv; charset=UTF-8',\n             'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n             'Pragma' => 'no-cache',\n@@ -391,8 +132,15 @@\n \n             fclose($file);\n         };\n \n+        // حفظ رسالة النجاح في الجلسة\n+        $existingCount = count($existingData);\n+        $newCount = count($newData);\n+        $totalCount = count($mergedData);\n+        \n+        session()->flash('success', \"تم دمج البيانات بنجاح! (السجلات السابقة: $existingCount + السجلات الجديدة: $newCount = الإجمالي: $totalCount)\");\n+\n         return response()->stream($callback, 200, $headers);\n     }\n \n     private function readCSV($file)\n@@ -400,10 +148,21 @@\n         $data = [];\n         $path = $file->getRealPath();\n         \n         if (($handle = fopen($path, 'r')) !== false) {\n+            // قراءة BOM إذا كان موجوداً\n+            $bom = fread($handle, 3);\n+            if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n+                rewind($handle);\n+            }\n+            \n             $headers = fgetcsv($handle);\n             \n+            if ($headers === false) {\n+                fclose($handle);\n+                throw new \\Exception('الملف فارغ أو تالف');\n+            }\n+            \n             while (($row = fgetcsv($handle)) !== false) {\n                 if (count($headers) === count($row)) {\n                     $data[] = array_combine($headers, $row);\n                 }\n@@ -421,19 +180,26 @@\n             $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n             $sheet = $spreadsheet->getActiveSheet();\n             $rows = $sheet->toArray();\n             \n+            if (empty($rows)) {\n+                throw new \\Exception('الملف فارغ');\n+            }\n+            \n             $headers = array_shift($rows);\n             $data = [];\n             \n             foreach ($rows as $row) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n+                // تجاهل الصفوف الفارغة\n+                if (array_filter($row)) {\n+                    if (count($headers) === count($row)) {\n+                        $data[] = array_combine($headers, $row);\n+                    }\n                 }\n             }\n             \n             return $data;\n         } catch (\\Exception $e) {\n-            return [];\n+            throw new \\Exception('فشل قراءة ملف Excel: ' . $e->getMessage());\n         }\n     }\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762476962672,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,20 +6,8 @@\n use Illuminate\\Support\\Facades\\Storage;\n \n class ExcelController extends Controller\n {\n-    // عرض صفحة اختيار نوع التصدير\n-    public function showExportOptions()\n-    {\n-        $data = session('extracted_data', []);\n-        \n-        if (empty($data)) {\n-            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n-        }\n-\n-        return view('pdf.export-options', ['dataCount' => count($data)]);\n-    }\n-\n     public function downloadExcel(Request $request)\n     {\n         $data = session('extracted_data', []);\n         \n@@ -63,22 +51,15 @@\n \n             fclose($file);\n         };\n \n-        // حفظ رسالة النجاح في الجلسة\n-        session()->flash('success', 'تم إنشاء الملف الجديد وتحميله بنجاح! (' . count($data) . ' سجل)');\n-\n         return response()->stream($callback, 200, $headers);\n     }\n \n     private function appendToExistingFile(Request $request, $newData)\n     {\n         $request->validate([\n             'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n-        ], [\n-            'existing_file.required' => 'يرجى اختيار ملف موجود',\n-            'existing_file.mimes' => 'يجب أن يكون الملف من نوع CSV أو Excel',\n-            'existing_file.max' => 'حجم الملف يجب أن لا يتجاوز 10 ميجابايت'\n         ]);\n \n         $existingFile = $request->file('existing_file');\n         $extension = strtolower($existingFile->getClientOriginalExtension());\n@@ -91,18 +72,18 @@\n             } elseif (in_array($extension, ['xlsx', 'xls'])) {\n                 $existingData = $this->readExcel($existingFile);\n             }\n         } catch (\\Exception $e) {\n-            return redirect()->back()->with('error', 'فشل قراءة الملف الموجود: ' . $e->getMessage());\n+            return redirect()->back()->with('error', 'Failed to read existing file: ' . $e->getMessage());\n         }\n \n         // التحقق من تطابق الأعمدة\n         if (!empty($existingData) && !empty($newData)) {\n             $existingColumns = array_keys($existingData[0]);\n             $newColumns = array_keys($newData[0]);\n             \n             if ($existingColumns !== $newColumns) {\n-                return redirect()->back()->with('error', 'أعمدة الملف الموجود لا تتطابق مع البيانات الجديدة.');\n+                return redirect()->back()->with('error', 'Columns in the existing file do not match the new data.');\n             }\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n@@ -132,15 +113,8 @@\n \n             fclose($file);\n         };\n \n-        // حفظ رسالة النجاح في الجلسة\n-        $existingCount = count($existingData);\n-        $newCount = count($newData);\n-        $totalCount = count($mergedData);\n-        \n-        session()->flash('success', \"تم دمج البيانات بنجاح! (السجلات السابقة: $existingCount + السجلات الجديدة: $newCount = الإجمالي: $totalCount)\");\n-\n         return response()->stream($callback, 200, $headers);\n     }\n \n     private function readCSV($file)\n"
                },
                {
                    "date": 1762476972559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,9 +122,8 @@\n         $data = [];\n         $path = $file->getRealPath();\n         \n         if (($handle = fopen($path, 'r')) !== false) {\n-            // قراءة BOM إذا كان موجوداً\n             $bom = fread($handle, 3);\n             if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n                 rewind($handle);\n             }\n@@ -162,9 +161,8 @@\n             $headers = array_shift($rows);\n             $data = [];\n             \n             foreach ($rows as $row) {\n-                // تجاهل الصفوف الفارغة\n                 if (array_filter($row)) {\n                     if (count($headers) === count($row)) {\n                         $data[] = array_combine($headers, $row);\n                     }\n"
                },
                {
                    "date": 1762476978806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,176 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n+\n+class ExcelController extends Controller\n+{\n+    public function downloadExcel(Request $request)\n+    {\n+        $data = session('extracted_data', []);\n+        \n+        if (empty($data)) {\n+            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n+        }\n+\n+        $exportType = $request->get('type', 'new');\n+\n+        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n+            return $this->appendToExistingFile($request, $data);\n+        }\n+\n+        return $this->createNewFile($data);\n+    }\n+\n+    private function createNewFile($data)\n+    {\n+        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($data) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($data)) {\n+                fputcsv($file, array_keys($data[0]));\n+            }\n+\n+            foreach ($data as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function appendToExistingFile(Request $request, $newData)\n+    {\n+        $request->validate([\n+            'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n+        ]);\n+\n+        $existingFile = $request->file('existing_file');\n+        $extension = strtolower($existingFile->getClientOriginalExtension());\n+\n+        $existingData = [];\n+        \n+        try {\n+            if ($extension === 'csv') {\n+                $existingData = $this->readCSV($existingFile);\n+            } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+                $existingData = $this->readExcel($existingFile);\n+            }\n+        } catch (\\Exception $e) {\n+            return redirect()->back()->with('error', 'Failed to read existing file: ' . $e->getMessage());\n+        }\n+\n+        if (!empty($existingData) && !empty($newData)) {\n+            $existingColumns = array_keys($existingData[0]);\n+            $newColumns = array_keys($newData[0]);\n+            \n+            if ($existingColumns !== $newColumns) {\n+                return redirect()->back()->with('error', 'Columns in the existing file do not match the new data.');\n+            }\n+        }\n+\n+        $mergedData = array_merge($existingData, $newData);\n+        $originalFilename = pathinfo($existingFile->getClientOriginalName(), PATHINFO_FILENAME);\n+        $filename = $originalFilename . '_merged_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($mergedData) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($mergedData)) {\n+                fputcsv($file, array_keys($mergedData[0]));\n+            }\n+\n+            foreach ($mergedData as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function readCSV($file)\n+    {\n+        $data = [];\n+        $path = $file->getRealPath();\n+        \n+        if (($handle = fopen($path, 'r')) !== false) {\n+            $bom = fread($handle, 3);\n+            if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n+                rewind($handle);\n+            }\n+            \n+            $headers = fgetcsv($handle);\n+            \n+            if ($headers === false) {\n+                fclose($handle);\n+                throw new \\Exception('الملف فارغ أو تالف');\n+            }\n+            \n+            while (($row = fgetcsv($handle)) !== false) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                }\n+            }\n+            \n+            fclose($handle);\n+        }\n+        \n+        return $data;\n+    }\n+\n+    private function readExcel($file)\n+    {\n+        try {\n+            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n+            $sheet = $spreadsheet->getActiveSheet();\n+            $rows = $sheet->toArray();\n+            \n+            if (empty($rows)) {\n+                throw new \\Exception('الملف فارغ');\n+            }\n+            \n+            $headers = array_shift($rows);\n+            $data = [];\n+            \n+            foreach ($rows as $row) {\n+                if (array_filter($row)) {\n+                    if (count($headers) === count($row)) {\n+                        $data[] = array_combine($headers, $row);\n+                    }\n+                }\n+            }\n+            \n+            return $data;\n+        } catch (\\Exception $e) {\n+            throw new \\Exception('فشل قراءة ملف Excel: ' . $e->getMessage());\n+        }\n+    }\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1762477162635,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,188 +16,18 @@\n         }\n \n         $exportType = $request->get('type', 'new');\n \n-        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n+        // التحقق من أن الطلب POST ويوجد ملف مرفوع\n+        if ($request->isMethod('post') && $request->hasFile('existing_file')) {\n             return $this->appendToExistingFile($request, $data);\n         }\n \n-        return $this->createNewFile($data);\n-    }\n-\n-    private function createNewFile($data)\n-    {\n-        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($data) {\n-            $file = fopen('php://output', 'w');\n-            \n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            if (!empty($data)) {\n-                fputcsv($file, array_keys($data[0]));\n-            }\n-\n-            foreach ($data as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function appendToExistingFile(Request $request, $newData)\n-    {\n-        $request->validate([\n-            'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n-        ]);\n-\n-        $existingFile = $request->file('existing_file');\n-        $extension = strtolower($existingFile->getClientOriginalExtension());\n-\n-        $existingData = [];\n-        \n-        try {\n-            if ($extension === 'csv') {\n-                $existingData = $this->readCSV($existingFile);\n-            } elseif (in_array($extension, ['xlsx', 'xls'])) {\n-                $existingData = $this->readExcel($existingFile);\n-            }\n-        } catch (\\Exception $e) {\n-            return redirect()->back()->with('error', 'Failed to read existing file: ' . $e->getMessage());\n+        // التحقق من نوع التصدير\n+        if ($exportType === 'existing') {\n+            return redirect()->back()->with('error', 'Please select a file to append data to.');\n         }\n \n-        if (!empty($existingData) && !empty($newData)) {\n-            $existingColumns = array_keys($existingData[0]);\n-            $newColumns = array_keys($newData[0]);\n-            \n-            if ($existingColumns !== $newColumns) {\n-                return redirect()->back()->with('error', 'Columns in the existing file do not match the new data.');\n-            }\n-        }\n-\n-        $mergedData = array_merge($existingData, $newData);\n-        $originalFilename = pathinfo($existingFile->getClientOriginalName(), PATHINFO_FILENAME);\n-        $filename = $originalFilename . '_merged_' . date('Y-m-d_His') . '.csv';\n-\n-        $headers = [\n-            'Content-Type' => 'text/csv; charset=UTF-8',\n-            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n-            'Pragma' => 'no-cache',\n-            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n-            'Expires' => '0',\n-        ];\n-\n-        $callback = function () use ($mergedData) {\n-            $file = fopen('php://output', 'w');\n-            \n-            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n-\n-            if (!empty($mergedData)) {\n-                fputcsv($file, array_keys($mergedData[0]));\n-            }\n-\n-            foreach ($mergedData as $row) {\n-                fputcsv($file, $row);\n-            }\n-\n-            fclose($file);\n-        };\n-\n-        return response()->stream($callback, 200, $headers);\n-    }\n-\n-    private function readCSV($file)\n-    {\n-        $data = [];\n-        $path = $file->getRealPath();\n-        \n-        if (($handle = fopen($path, 'r')) !== false) {\n-            $bom = fread($handle, 3);\n-            if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n-                rewind($handle);\n-            }\n-            \n-            $headers = fgetcsv($handle);\n-            \n-            if ($headers === false) {\n-                fclose($handle);\n-                throw new \\Exception('الملف فارغ أو تالف');\n-            }\n-            \n-            while (($row = fgetcsv($handle)) !== false) {\n-                if (count($headers) === count($row)) {\n-                    $data[] = array_combine($headers, $row);\n-                }\n-            }\n-            \n-            fclose($handle);\n-        }\n-        \n-        return $data;\n-    }\n-\n-    private function readExcel($file)\n-    {\n-        try {\n-            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n-            $sheet = $spreadsheet->getActiveSheet();\n-            $rows = $sheet->toArray();\n-            \n-            if (empty($rows)) {\n-                throw new \\Exception('الملف فارغ');\n-            }\n-            \n-            $headers = array_shift($rows);\n-            $data = [];\n-            \n-            foreach ($rows as $row) {\n-                if (array_filter($row)) {\n-                    if (count($headers) === count($row)) {\n-                        $data[] = array_combine($headers, $row);\n-                    }\n-                }\n-            }\n-            \n-            return $data;\n-        } catch (\\Exception $e) {\n-            throw new \\Exception('فشل قراءة ملف Excel: ' . $e->getMessage());\n-        }\n-    }\n-}\n-<?php\n-\n-namespace App\\Http\\Controllers;\n-\n-use Illuminate\\Http\\Request;\n-use Illuminate\\Support\\Facades\\Storage;\n-\n-class ExcelController extends Controller\n-{\n-    public function downloadExcel(Request $request)\n-    {\n-        $data = session('extracted_data', []);\n-        \n-        if (empty($data)) {\n-            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n-        }\n-\n-        $exportType = $request->get('type', 'new');\n-\n-        if ($exportType === 'existing' && $request->hasFile('existing_file')) {\n-            return $this->appendToExistingFile($request, $data);\n-        }\n-\n         return $this->createNewFile($data);\n     }\n \n     private function createNewFile($data)\n@@ -298,8 +128,9 @@\n         $data = [];\n         $path = $file->getRealPath();\n         \n         if (($handle = fopen($path, 'r')) !== false) {\n+            // قراءة BOM إذا كان موجوداً\n             $bom = fread($handle, 3);\n             if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n                 rewind($handle);\n             }\n@@ -337,8 +168,9 @@\n             $headers = array_shift($rows);\n             $data = [];\n             \n             foreach ($rows as $row) {\n+                // تجاهل الصفوف الفارغة\n                 if (array_filter($row)) {\n                     if (count($headers) === count($row)) {\n                         $data[] = array_combine($headers, $row);\n                     }\n"
                },
                {
                    "date": 1762477706035,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,9 +11,9 @@\n     {\n         $data = session('extracted_data', []);\n         \n         if (empty($data)) {\n-            return redirect()->back()->with('error', 'لا توجد بيانات للتصدير.');\n+            return redirect()->route('pdf.fields')->with('error', 'No data to export. Please extract data first.');\n         }\n \n         $exportType = $request->get('type', 'new');\n \n@@ -23,9 +23,9 @@\n         }\n \n         // التحقق من نوع التصدير\n         if ($exportType === 'existing') {\n-            return redirect()->back()->with('error', 'Please select a file to append data to.');\n+            return redirect()->route('pdf.fields')->with('error', 'Please select a file to append data to.');\n         }\n \n         return $this->createNewFile($data);\n     }\n"
                },
                {
                    "date": 1762478022521,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,16 +16,24 @@\n         }\n \n         $exportType = $request->get('type', 'new');\n \n+        \\Log::info('Export Request', [\n+            'method' => $request->method(),\n+            'type' => $exportType,\n+            'has_file' => $request->hasFile('existing_file'),\n+            'is_post' => $request->isMethod('post'),\n+            'all_files' => $request->allFiles(),\n+        ]);\n+\n         // التحقق من أن الطلب POST ويوجد ملف مرفوع\n         if ($request->isMethod('post') && $request->hasFile('existing_file')) {\n             return $this->appendToExistingFile($request, $data);\n         }\n \n         // التحقق من نوع التصدير\n         if ($exportType === 'existing') {\n-            return redirect()->route('pdf.fields')->with('error', 'Please select a file to append data to.');\n+            return redirect()->route('pdf.results')->with('error', 'Please select a file to append data to.');\n         }\n \n         return $this->createNewFile($data);\n     }\n@@ -62,38 +70,66 @@\n     }\n \n     private function appendToExistingFile(Request $request, $newData)\n     {\n+        \\Log::info('Append to existing file started');\n+        \n         $request->validate([\n             'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n         ]);\n \n         $existingFile = $request->file('existing_file');\n         $extension = strtolower($existingFile->getClientOriginalExtension());\n \n+        \\Log::info('File received', [\n+            'name' => $existingFile->getClientOriginalName(),\n+            'extension' => $extension,\n+            'size' => $existingFile->getSize(),\n+        ]);\n+\n         $existingData = [];\n         \n         try {\n             if ($extension === 'csv') {\n                 $existingData = $this->readCSV($existingFile);\n             } elseif (in_array($extension, ['xlsx', 'xls'])) {\n                 $existingData = $this->readExcel($existingFile);\n             }\n+            \n+            \\Log::info('Existing data read', [\n+                'rows' => count($existingData),\n+                'columns' => !empty($existingData) ? array_keys($existingData[0]) : [],\n+            ]);\n+            \n         } catch (\\Exception $e) {\n-            return redirect()->back()->with('error', 'Failed to read existing file: ' . $e->getMessage());\n+            \\Log::error('Failed to read file: ' . $e->getMessage());\n+            return redirect()->route('pdf.results')->with('error', 'Failed to read existing file: ' . $e->getMessage());\n         }\n \n         // التحقق من تطابق الأعمدة\n         if (!empty($existingData) && !empty($newData)) {\n             $existingColumns = array_keys($existingData[0]);\n             $newColumns = array_keys($newData[0]);\n             \n+            \\Log::info('Column comparison', [\n+                'existing' => $existingColumns,\n+                'new' => $newColumns,\n+                'match' => $existingColumns === $newColumns,\n+            ]);\n+            \n             if ($existingColumns !== $newColumns) {\n-                return redirect()->back()->with('error', 'Columns in the existing file do not match the new data.');\n+                return redirect()->route('pdf.results')->with('error', 'Columns in the existing file do not match the new data. Existing: ' . implode(', ', $existingColumns) . ' | New: ' . implode(', ', $newColumns));\n             }\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n+        \n+        \\Log::info('Data merged', [\n+            'existing_rows' => count($existingData),\n+            'new_rows' => count($newData),\n+            'total_rows' => count($mergedData),\n+        ]);\n+        \n         $originalFilename = pathinfo($existingFile->getClientOriginalName(), PATHINFO_FILENAME);\n         $filename = $originalFilename . '_merged_' . date('Y-m-d_His') . '.csv';\n \n         $headers = [\n"
                },
                {
                    "date": 1762478274259,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,11 +72,16 @@\n     private function appendToExistingFile(Request $request, $newData)\n     {\n         \\Log::info('Append to existing file started');\n         \n-        $request->validate([\n-            'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n-        ]);\n+        try {\n+            $request->validate([\n+                'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n+            ]);\n+        } catch (\\Illuminate\\Validation\\ValidationException $e) {\n+            \\Log::error('Validation failed', ['errors' => $e->errors()]);\n+            return response()->json(['error' => 'Validation failed: ' . json_encode($e->errors())], 422);\n+        }\n \n         $existingFile = $request->file('existing_file');\n         $extension = strtolower($existingFile->getClientOriginalExtension());\n \n@@ -101,9 +106,9 @@\n             ]);\n             \n         } catch (\\Exception $e) {\n             \\Log::error('Failed to read file: ' . $e->getMessage());\n-            return redirect()->route('pdf.results')->with('error', 'Failed to read existing file: ' . $e->getMessage());\n+            return response()->json(['error' => 'Failed to read existing file: ' . $e->getMessage()], 400);\n         }\n \n         // التحقق من تطابق الأعمدة\n         if (!empty($existingData) && !empty($newData)) {\n@@ -116,15 +121,17 @@\n                 'match' => $existingColumns === $newColumns,\n             ]);\n             \n             if ($existingColumns !== $newColumns) {\n-                return redirect()->route('pdf.results')->with('error', 'Columns in the existing file do not match the new data. Existing: ' . implode(', ', $existingColumns) . ' | New: ' . implode(', ', $newColumns));\n+                $error = 'Columns mismatch! Existing: [' . implode(', ', $existingColumns) . '] | New: [' . implode(', ', $newColumns) . ']';\n+                \\Log::error($error);\n+                return response()->json(['error' => $error], 400);\n             }\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n         \n-        \\Log::info('Data merged', [\n+        \\Log::info('Data merged successfully', [\n             'existing_rows' => count($existingData),\n             'new_rows' => count($newData),\n             'total_rows' => count($mergedData),\n         ]);\n@@ -163,8 +170,10 @@\n     {\n         $data = [];\n         $path = $file->getRealPath();\n         \n+        \\Log::info('Reading CSV', ['path' => $path, 'exists' => file_exists($path)]);\n+        \n         if (($handle = fopen($path, 'r')) !== false) {\n             // قراءة BOM إذا كان موجوداً\n             $bom = fread($handle, 3);\n             if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n@@ -172,20 +181,35 @@\n             }\n             \n             $headers = fgetcsv($handle);\n             \n+            \\Log::info('CSV Headers', ['headers' => $headers]);\n+            \n             if ($headers === false) {\n                 fclose($handle);\n-                throw new \\Exception('الملف فارغ أو تالف');\n+                throw new \\Exception('Empty or corrupted file');\n             }\n             \n+            $rowCount = 0;\n             while (($row = fgetcsv($handle)) !== false) {\n                 if (count($headers) === count($row)) {\n                     $data[] = array_combine($headers, $row);\n+                    $rowCount++;\n+                } else {\n+                    \\Log::warning('Row skipped - column mismatch', [\n+                        'expected' => count($headers),\n+                        'got' => count($row),\n+                        'row' => $row\n+                    ]);\n                 }\n             }\n             \n+            \\Log::info('CSV Read Complete', ['rows' => $rowCount]);\n+            \n             fclose($handle);\n+        } else {\n+            \\Log::error('Could not open CSV file', ['path' => $path]);\n+            throw new \\Exception('Could not open file');\n         }\n         \n         return $data;\n     }\n"
                },
                {
                    "date": 1762478481421,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,10 +74,11 @@\n         \\Log::info('Append to existing file started');\n         \n         try {\n             $request->validate([\n-                'existing_file' => 'required|file|mimes:csv,xlsx,xls|max:10240'\n+                'existing_file' => 'required|file|mimetypes:text/csv,text/plain,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet|max:10240'\n             ]);\n+            \n         } catch (\\Illuminate\\Validation\\ValidationException $e) {\n             \\Log::error('Validation failed', ['errors' => $e->errors()]);\n             return response()->json(['error' => 'Validation failed: ' . json_encode($e->errors())], 422);\n         }\n"
                },
                {
                    "date": 1762478700852,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,8 +129,10 @@\n             }\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n+        $mergedData = array_map(\"unserialize\", array_unique(array_map(\"serialize\", $mergedData)));\n+\n         \n         \\Log::info('Data merged successfully', [\n             'existing_rows' => count($existingData),\n             'new_rows' => count($newData),\n"
                },
                {
                    "date": 1762478820759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,9 +24,8 @@\n             'is_post' => $request->isMethod('post'),\n             'all_files' => $request->allFiles(),\n         ]);\n \n-        // التحقق من أن الطلب POST ويوجد ملف مرفوع\n         if ($request->isMethod('post') && $request->hasFile('existing_file')) {\n             return $this->appendToExistingFile($request, $data);\n         }\n \n@@ -130,9 +129,8 @@\n         }\n \n         $mergedData = array_merge($existingData, $newData);\n         $mergedData = array_map(\"unserialize\", array_unique(array_map(\"serialize\", $mergedData)));\n-\n         \n         \\Log::info('Data merged successfully', [\n             'existing_rows' => count($existingData),\n             'new_rows' => count($newData),\n"
                },
                {
                    "date": 1762478842120,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,9 +28,8 @@\n         if ($request->isMethod('post') && $request->hasFile('existing_file')) {\n             return $this->appendToExistingFile($request, $data);\n         }\n \n-        // التحقق من نوع التصدير\n         if ($exportType === 'existing') {\n             return redirect()->route('pdf.results')->with('error', 'Please select a file to append data to.');\n         }\n \n@@ -109,9 +108,8 @@\n             \\Log::error('Failed to read file: ' . $e->getMessage());\n             return response()->json(['error' => 'Failed to read existing file: ' . $e->getMessage()], 400);\n         }\n \n-        // التحقق من تطابق الأعمدة\n         if (!empty($existingData) && !empty($newData)) {\n             $existingColumns = array_keys($existingData[0]);\n             $newColumns = array_keys($newData[0]);\n             \n"
                },
                {
                    "date": 1762478880981,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -172,9 +172,8 @@\n         \n         \\Log::info('Reading CSV', ['path' => $path, 'exists' => file_exists($path)]);\n         \n         if (($handle = fopen($path, 'r')) !== false) {\n-            // قراءة BOM إذا كان موجوداً\n             $bom = fread($handle, 3);\n             if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n                 rewind($handle);\n             }\n"
                },
                {
                    "date": 1762478888337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -226,9 +226,8 @@\n             $headers = array_shift($rows);\n             $data = [];\n             \n             foreach ($rows as $row) {\n-                // تجاهل الصفوف الفارغة\n                 if (array_filter($row)) {\n                     if (count($headers) === count($row)) {\n                         $data[] = array_combine($headers, $row);\n                     }\n"
                },
                {
                    "date": 1762478900532,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -219,9 +219,9 @@\n             $sheet = $spreadsheet->getActiveSheet();\n             $rows = $sheet->toArray();\n             \n             if (empty($rows)) {\n-                throw new \\Exception(''الملف فارغ'');\n+                throw new \\Exception(''الملف فارغ');\n             }\n             \n             $headers = array_shift($rows);\n             $data = [];\n"
                },
                {
                    "date": 1762478910311,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,242 @@\n+<?php\n+\n+namespace App\\Http\\Controllers;\n+\n+use Illuminate\\Http\\Request;\n+use Illuminate\\Support\\Facades\\Storage;\n+\n+class ExcelController extends Controller\n+{\n+    public function downloadExcel(Request $request)\n+    {\n+        $data = session('extracted_data', []);\n+        \n+        if (empty($data)) {\n+            return redirect()->route('pdf.fields')->with('error', 'No data to export. Please extract data first.');\n+        }\n+\n+        $exportType = $request->get('type', 'new');\n+\n+        \\Log::info('Export Request', [\n+            'method' => $request->method(),\n+            'type' => $exportType,\n+            'has_file' => $request->hasFile('existing_file'),\n+            'is_post' => $request->isMethod('post'),\n+            'all_files' => $request->allFiles(),\n+        ]);\n+\n+        if ($request->isMethod('post') && $request->hasFile('existing_file')) {\n+            return $this->appendToExistingFile($request, $data);\n+        }\n+\n+        if ($exportType === 'existing') {\n+            return redirect()->route('pdf.results')->with('error', 'Please select a file to append data to.');\n+        }\n+\n+        return $this->createNewFile($data);\n+    }\n+\n+    private function createNewFile($data)\n+    {\n+        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($data) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($data)) {\n+                fputcsv($file, array_keys($data[0]));\n+            }\n+\n+            foreach ($data as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function appendToExistingFile(Request $request, $newData)\n+    {\n+        \\Log::info('Append to existing file started');\n+        \n+        try {\n+            $request->validate([\n+                'existing_file' => 'required|file|mimetypes:text/csv,text/plain,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet|max:10240'\n+            ]);\n+            \n+        } catch (\\Illuminate\\Validation\\ValidationException $e) {\n+            \\Log::error('Validation failed', ['errors' => $e->errors()]);\n+            return response()->json(['error' => 'Validation failed: ' . json_encode($e->errors())], 422);\n+        }\n+\n+        $existingFile = $request->file('existing_file');\n+        $extension = strtolower($existingFile->getClientOriginalExtension());\n+\n+        \\Log::info('File received', [\n+            'name' => $existingFile->getClientOriginalName(),\n+            'extension' => $extension,\n+            'size' => $existingFile->getSize(),\n+        ]);\n+\n+        $existingData = [];\n+        \n+        try {\n+            if ($extension === 'csv') {\n+                $existingData = $this->readCSV($existingFile);\n+            } elseif (in_array($extension, ['xlsx', 'xls'])) {\n+                $existingData = $this->readExcel($existingFile);\n+            }\n+            \n+            \\Log::info('Existing data read', [\n+                'rows' => count($existingData),\n+                'columns' => !empty($existingData) ? array_keys($existingData[0]) : [],\n+            ]);\n+            \n+        } catch (\\Exception $e) {\n+            \\Log::error('Failed to read file: ' . $e->getMessage());\n+            return response()->json(['error' => 'Failed to read existing file: ' . $e->getMessage()], 400);\n+        }\n+\n+        if (!empty($existingData) && !empty($newData)) {\n+            $existingColumns = array_keys($existingData[0]);\n+            $newColumns = array_keys($newData[0]);\n+            \n+            \\Log::info('Column comparison', [\n+                'existing' => $existingColumns,\n+                'new' => $newColumns,\n+                'match' => $existingColumns === $newColumns,\n+            ]);\n+            \n+            if ($existingColumns !== $newColumns) {\n+                $error = 'Columns mismatch! Existing: [' . implode(', ', $existingColumns) . '] | New: [' . implode(', ', $newColumns) . ']';\n+                \\Log::error($error);\n+                return response()->json(['error' => $error], 400);\n+            }\n+        }\n+\n+        $mergedData = array_merge($existingData, $newData);\n+        $mergedData = array_map(\"unserialize\", array_unique(array_map(\"serialize\", $mergedData)));\n+        \n+        \\Log::info('Data merged successfully', [\n+            'existing_rows' => count($existingData),\n+            'new_rows' => count($newData),\n+            'total_rows' => count($mergedData),\n+        ]);\n+        \n+        $originalFilename = pathinfo($existingFile->getClientOriginalName(), PATHINFO_FILENAME);\n+        $filename = $originalFilename . '_merged_' . date('Y-m-d_His') . '.csv';\n+\n+        $headers = [\n+            'Content-Type' => 'text/csv; charset=UTF-8',\n+            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n+            'Pragma' => 'no-cache',\n+            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n+            'Expires' => '0',\n+        ];\n+\n+        $callback = function () use ($mergedData) {\n+            $file = fopen('php://output', 'w');\n+            \n+            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n+\n+            if (!empty($mergedData)) {\n+                fputcsv($file, array_keys($mergedData[0]));\n+            }\n+\n+            foreach ($mergedData as $row) {\n+                fputcsv($file, $row);\n+            }\n+\n+            fclose($file);\n+        };\n+\n+        return response()->stream($callback, 200, $headers);\n+    }\n+\n+    private function readCSV($file)\n+    {\n+        $data = [];\n+        $path = $file->getRealPath();\n+        \n+        \\Log::info('Reading CSV', ['path' => $path, 'exists' => file_exists($path)]);\n+        \n+        if (($handle = fopen($path, 'r')) !== false) {\n+            $bom = fread($handle, 3);\n+            if ($bom !== chr(0xEF).chr(0xBB).chr(0xBF)) {\n+                rewind($handle);\n+            }\n+            \n+            $headers = fgetcsv($handle);\n+            \n+            \\Log::info('CSV Headers', ['headers' => $headers]);\n+            \n+            if ($headers === false) {\n+                fclose($handle);\n+                throw new \\Exception('Empty or corrupted file');\n+            }\n+            \n+            $rowCount = 0;\n+            while (($row = fgetcsv($handle)) !== false) {\n+                if (count($headers) === count($row)) {\n+                    $data[] = array_combine($headers, $row);\n+                    $rowCount++;\n+                } else {\n+                    \\Log::warning('Row skipped - column mismatch', [\n+                        'expected' => count($headers),\n+                        'got' => count($row),\n+                        'row' => $row\n+                    ]);\n+                }\n+            }\n+            \n+            \\Log::info('CSV Read Complete', ['rows' => $rowCount]);\n+            \n+            fclose($handle);\n+        } else {\n+            \\Log::error('Could not open CSV file', ['path' => $path]);\n+            throw new \\Exception('Could not open file');\n+        }\n+        \n+        return $data;\n+    }\n+\n+    private function readExcel($file)\n+    {\n+        try {\n+            $spreadsheet = \\PhpOffice\\PhpSpreadsheet\\IOFactory::load($file->getRealPath());\n+            $sheet = $spreadsheet->getActiveSheet();\n+            $rows = $sheet->toArray();\n+            \n+            if (empty($rows)) {\n+                throw new \\Exception('The file is Empty');\n+            }\n+            \n+            $headers = array_shift($rows);\n+            $data = [];\n+            \n+            foreach ($rows as $row) {\n+                if (array_filter($row)) {\n+                    if (count($headers) === count($row)) {\n+                        $data[] = array_combine($headers, $row);\n+                    }\n+                }\n+            }\n+            \n+            return $data;\n+        } catch (\\Exception $e) {\n+            throw new \\Exception('فشل قراءة ملف Excel: ' . $e->getMessage());\n+        }\n+    }\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1762469581934,
            "name": "Commit-0",
            "content": "<?php\nnamespace App\\Http\\Controllers;\n\nuse Illuminate\\Support\\Facades\\Response;\n\nclass ExcelController extends Controller\n{\n    public function downloadExcel()\n    {\n        $data = session('extracted_data', []);\n\n        if (empty($data)) {\n            return redirect()->back()\n                ->with('error', 'No data to export.');\n        }\n\n        $filename = 'extracted_data_' . date('Y-m-d_His') . '.csv';\n\n        $headers = [\n            'Content-Type' => 'text/csv; charset=UTF-8',\n            'Content-Disposition' => \"attachment; filename=\\\"$filename\\\"\",\n            'Pragma' => 'no-cache',\n            'Cache-Control' => 'must-revalidate, post-check=0, pre-check=0',\n            'Expires' => '0',\n        ];\n\n        $callback = function () use ($data) {\n            $file = fopen('php://output', 'w');\n\n            // Add BOM for Excel UTF-8 support\n            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));\n\n            // Write headers\n            if (!empty($data)) {\n                fputcsv($file, array_keys($data[0]));\n            }\n\n            // Write data\n            foreach ($data as $row) {\n                fputcsv($file, $row);\n            }\n\n            fclose($file);\n        };\n\n        return response()->stream($callback, 200, $headers);\n    }\n}"
        }
    ]
}